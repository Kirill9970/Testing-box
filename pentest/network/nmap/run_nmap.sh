#!/bin/bash
set -e

# Загрузка переменных из .env
ENV_FILE=".env"
if [ ! -f "$ENV_FILE" ]; then
  echo "Файл $ENV_FILE не найден!"
  exit 1
fi

set -a
source "$ENV_FILE"
set +a

# Проверка наличия docker
if ! command -v docker &> /dev/null; then
  echo "Docker не найден. Установите его."
  exit 1
fi

# Проверка обязательных переменных
REQUIRED_VARS=(NMAP_TARGET NMAP_OUTPUT NMAP_OUTPUT_FORMAT)
for var in "${REQUIRED_VARS[@]}"; do
  if [ -z "${!var}" ]; then
    echo "Ошибка: переменная $var не задана в $ENV_FILE"
    exit 1
  fi
done

OUTPUT_DIR="$(pwd)/output"
mkdir -p "$OUTPUT_DIR"

EXTRA_OPTS="${NMAP_OPTIONS:-}" # дополнительные опции, если заданы

# Формируем команду для вывода в нужный формат
if [ "$NMAP_OUTPUT_FORMAT" = "xml" ]; then
  OUT_OPT="-oX /output/$NMAP_OUTPUT"
else
  OUT_OPT="-oN /output/$NMAP_OUTPUT"
fi

echo "Запуск nmap..."
docker run --rm \
  -v "$OUTPUT_DIR:/output" \
  --network=host \
  instrumentisto/nmap \
    $EXTRA_OPTS \
    $NMAP_TARGET \
    $OUT_OPT

echo "Отчет nmap сохранен в output/$NMAP_OUTPUT" 