#!/bin/bash
set -e

# Загрузка переменных из .env
ENV_FILE=".env"
if [ ! -f "$ENV_FILE" ]; then
  echo "Файл $ENV_FILE не найден!"
  exit 1
fi

set -a
source "$ENV_FILE"
set +a

# Проверка наличия docker
if ! command -v docker &> /dev/null; then
  echo "Docker не найден. Установите его."
  exit 1
fi

# Проверка обязательных переменных
REQUIRED_VARS=(NUCLEI_TARGET_URL NUCLEI_SEVERITY NUCLEI_TEMPLATES NUCLEI_THREADS NUCLEI_TIMEOUT NUCLEI_OUTPUT)
for var in "${REQUIRED_VARS[@]}"; do
  if [ -z "${!var}" ]; then
    echo "Ошибка: переменная $var не задана в $ENV_FILE"
    exit 1
  fi
done

# Абсолютный путь к output
OUTPUT_DIR="$(pwd)/output"
mkdir -p "$OUTPUT_DIR"

# Формируем параметры для nuclei
NUCLEI_ARGS="-u $NUCLEI_TARGET_URL -severity $NUCLEI_SEVERITY -t $NUCLEI_TEMPLATES -c $NUCLEI_THREADS -timeout $NUCLEI_TIMEOUT -jsonl -o /data/$NUCLEI_OUTPUT"

# Запуск nuclei в Docker с volume в output и network=host
# Не используем sudo для docker, чтобы не было проблем с правами

echo "Запуск nuclei..."
docker run --rm  -v "$OUTPUT_DIR:/data" projectdiscovery/nuclei:latest $NUCLEI_ARGS

echo "Отчет nuclei сохранен в output/$NUCLEI_OUTPUT"
